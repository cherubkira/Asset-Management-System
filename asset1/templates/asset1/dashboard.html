{% extends "asset1/sidebar.html" %}
{% load static %}

{% block page_content %}

<!-- Dashboard Cards -->
<div class="d-flex flex-wrap" style="margin:10px 0;">

  <!-- Total Assets -->
  <div style="flex:0 0 25%; padding:5px;">
    <div class="card shadow-sm border-0">
      <div class="card-body bg-primary text-white rounded text-center p-2">
        <i class="bi bi-bank fs-1 d-block"></i>
        <h5>Total Assets</h5>
        <h3>{{ total_assets }}</h3>
      </div>
    </div>
  </div>

  <!-- Available -->
  <div style="flex:0 0 25%; padding:5px;">
    <div class="card shadow-sm border-0">
      <div class="card-body bg-success text-white rounded text-center p-2">
        <i class="bi bi-check2-circle fs-1 d-block"></i>
        <h5>Available</h5>
        <h3>{{ available }}</h3>
      </div>
    </div>
  </div>

  <!-- Assigned -->
  <div style="flex:0 0 25%; padding:5px;">
    <div class="card shadow-sm border-0">
      <div class="card-body bg-warning text-dark rounded text-center p-2">
        <i class="bi bi-people-fill fs-1 d-block"></i>
        <h5>Assigned</h5>
        <h3>{{ assigned }}</h3>
      </div>
    </div>
  </div>

  <!-- Pending -->
  <div style="flex:0 0 25%; padding:5px;">
    <div class="card shadow-sm border-0">
      <div class="card-body bg-danger text-white rounded text-center p-2">
        <i class="bi bi-person-lines-fill fs-1 d-block"></i>
        <h5>Pending Requests</h5>
        <h3>{{ pending_requests }}</h3>
      </div>
    </div>
  </div>

</div>

<!-- Recent Assignments Table -->
<h4 class="mt-3">Recent Assignments</h4>
<div style="overflow-x:auto;">
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Asset ID</th>
        <th>Asset Name</th>
        <th>From</th>
        <th>To</th>
        <th>At</th>
      </tr>
    </thead>
    <tbody>
      {% for a in recent_assignments %}
      <tr>
        <td>{{ a.asset.id }}</td>
        <td>{{ a.asset.name }}</td>
        <td>{{ a.assigned_from }}</td>
        <td>{{ a.assigned_to }}</td>
        <td>{{ a.created_at }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="text-center">No assignments yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Recent Users Table -->
<h4 class="mt-4">Recent Registered Users</h4>
<div class="table-responsive">
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Profile ID</th>
        <th>Profile Picture</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Phone Number</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      {% for user in recent_users %}
      <tr>
        <td>{{ user.profile_id }}</td>
        <td>
          {% if user.profile_picture %}
            <img src="{{ user.profile_picture.url }}" width="30" height="30" class="rounded-circle">
          {% else %}
            <img src="{% static 'img/default_profile.png' %}" width="30" height="30" class="rounded-circle">
          {% endif %}
        </td>
        <td>{{ user.first_name }}</td>
        <td>{{ user.last_name }}</td>
        <td>{{ user.phone_number }}</td>
        <td>{{ user.email }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center">No recent users found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Asset Allocation Pie Chart -->
<div class="card shadow mt-4">
  <div class="card-header py-2">
    <h6 class="m-0 font-weight-bold text-primary">Asset Allocation Summary</h6>
  </div>
  <div class="card-body">
    <div class="chart-area" style="max-height: 300px;">
      <canvas id="assetPieChart"></canvas>
      <div class="text-center mt-2">Assigned: {{ assigned_percentage }} %</div>
    </div>
  </div>
</div>

{% endblock page_content %}

{% block scripts %}
<!-- Pass Django variables safely to JS -->
{{ assigned|default:0|json_script:"assigned-data" }}
{{ available|default:0|json_script:"available-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Read the data safely from the JSON script tags
    const assetData = {
        assigned: JSON.parse(document.getElementById('assigned-data').textContent),
        unassigned: JSON.parse(document.getElementById('available-data').textContent),
    };

    const ctx = document.getElementById('assetPieChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Assigned', 'Unassigned'],
            datasets: [{
                data: [assetData.assigned, assetData.unassigned],
                backgroundColor: ['#4e73df', '#1cc88a'], // Blue and Green
                hoverBackgroundColor: ['#2e59d9', '#17a673'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    backgroundColor: "rgb(255,255,255)",
                    titleColor: "#858796",
                    bodyColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: false,
                },
                legend: { display: false }
            }
        },
    });
</script>

{% endblock scripts %}
